# Gemini Frontend for Long Context (Gemini fe4lc)

Gemini Frontend for Long Context（Gemini fe4lc）は、Google Gemini APIを使ったPWAチャットクライアントです。
「長いコンテキストでのチャット利用」に特化し、独自の新機能を追加しています。

元々はを便利に使っていたのですが、個別のシステムプロンプトが廃止されるに至って、自分好みのものを製作しました。

fork元のオリジナルGemini PWA Clientの作者さまといくつかのアイデアを参考にさせていただいた派生版の作者さまに感謝申し上げます。

- https://github.com/ona-oni/geminipwa
- https://github.com/titan823/geminipwa


## 特徴と意図

現在の大規模AIは、名目上の扱えるトークン数は大幅に増えていますが、ひとつのセッションが長くなるとプロンプト内の指示や設定の重みが薄まり、逸脱や忘却が起きやすくなるという課題があります。

そこで本アプリは：

* コンテキストの圧縮機能
* 常時使わないプロンプトの短縮と動的差し込み機能

によってこの課題を解決するために製作されてます。

平たく言うと「調子にのってセッション長引かせるとGeminiがだんだん狂ってくるのを何とかする」ために作られています。

## テスト環境と運用について

* Windows + Firefox（ローカルサーバー起動）での実運用とテストを行っています。
* PWAとしての基本機能（インストールやオフラインキャッシュ）は維持しているつもりですが、あまり保証できません。
* スマートフォンでは（動作はするはずですが）基本的にテストはしていません。

* 製作者は主にAIと行うゆるいTRPGに使用しています。小説執筆？や普通の雑談には使用していません。
* 1回の返答は約500トークン程度、5万〜10万トークンを1セッションとして運用し、10万トークン到達後は、手動で引継ぎ資料をAIと相談し、次のスレッドに移っています。

* ※ 嫁チャとかの方面にはあまり向かないと思います。

## 基本的な使い方

元アプリ「Gemini PWA Client」のREADMEを`README.original.md`として同梱していますのでそちらを参照してください。


## 新規機能

### 1. コンテキスト圧縮

長期セッション用に今までのやり取りをAIで自動要約し、総トークン数を減らしてコンテキストを圧縮する機能です。

* **AIはコンテキストの最初と最後を重視する傾向があり、中間部分は軽視されがちです。** よって、設定された分のやり取りを残して中間部分をあらすじ化してトークンを削減し、長期セッション運用を可能にします。

* 圧縮は「圧縮ボタン」を押したときのみ圧縮され、必要に応じて再圧縮も可能です。UIの表示上は圧縮後も元のメッセージが見えていますが、AIに投げる際には圧縮後のあらすじに置換てAPIを使用します。

* 引き継ぎ事項作成時など、全履歴を参照したい場合は削除することで元に戻せます。引継ぎ情報の作成くらいなら、元々の10万トークンを展開した状態でも割と大丈夫でした。

* AIが作成した要約を自分で修正したりすることも可能です。
  現状の仕様では中間部分だけを前提知識のないまま要約するので正確に圧縮されないこともあります。が、実運用では中間部分の情報は先述の通り重要度が低いため、大きな問題になることはないかと思います。

### 2. コンテキストノート

常時必要でないプロンプト（サブキャラクターの情報など）をサマリーと本体に分け、AIに動的に情報を提供する仕組みです。
「AIのべりすと」のキャラクターブックと似ていますが、次の点が異なります：

* タイトルと内容の1行目が「タイトル：1行目」という形の「サマリー」として常時提供されます。この仕組みによりAIが「存在を認識できない問題」を防止します。
* サマリーは、セッション開始時の2投稿目として自動的に動的に挿入されます。（セッションの記録としては残りません）

#### ノートの種類

* **キーワードタイプ**
  会話内の特定ワードに反応してAIに提示されます。要するにキャラクターブックです。
* **モーメントタイプ**
  ランダムで提示される記憶ノートです（キーワード反応も可能）。
  ※ 過去のキャンペーン履歴などへの使用を想定していますが、現在試験運用中です。

各スレッドにはデフォルトとして「コンテキストノート仕様」というコンテキストノートがセットされています。AIに聞くと内容を展開して読み込んだ上で詳細を答えてくれますので、聞いてみてください。

### 3. レスポンス置き換え

AIの返答に対して正規表現による置換処理を自動で行います。
トークン節約とは関係なく、Gemini特有の「ぴぎゃあ病」を抑制するために作りました。

* AI（モデル）の出力に対して、指定した正規表現で文字列を自動変換します。
* 編集結果はそのままモデルの出力内容として保存され、オリジナルは残りません。

## その他

### その他の細かい変更点

* **プロンプト確認**
  実際にGemini APIに送信されたプロンプトを閲覧できます。圧縮やコンテキストノートが実際にAIにどう送られているのかなどを確認することができます。

* **全チャットデータのバックアップ機能**
  全チャット履歴と設定（APIキーを除く）を1つのJSONに保存・復元できます。

* **デバッグ出力機能**
  レスポンス置き換えなどのテスト用に、API送信なしで空文字ないし設定した返答を返すことができます。

* **ユーザーインターフェースの変更**
  最上部・最下部への移動ボタンを追加しました。

* **HARM_CATEGORY_SEXUALLY_EXPLICITの度合い表示**
  モデルからの返答のHARM_CATEGORY_SEXUALLY_EXPLICITの度合いに応じて、ピンク枠で警告度を表示します。（AIの興奮度を視覚化するためにお遊びで実装した機能です）

### 注意点

* 圧縮や置き換え、動的挿入機能があるので、表示される様々なトークン数は目安です。100以下で誤差がありますが、気にしないでください。

### 使用ライブラリ

- https://github.com/markedjs/marked/
- https://github.com/nodeca/js-yaml/

### 更新履歴

- 2025/07/18 - リリース